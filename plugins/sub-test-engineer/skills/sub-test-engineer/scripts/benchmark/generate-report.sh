#!/usr/bin/env bash
# generate-report.sh â€” Generates markdown benchmark report from collected metrics.
# Usage: generate-report.sh <metrics-dir> [output-file]
#
# Reads all *-metrics.json files in the directory and produces a summary report.

set -euo pipefail

METRICS_DIR="${1:?Usage: generate-report.sh <metrics-dir> [output-file]}"
OUTPUT_FILE="${2:-$METRICS_DIR/benchmark-report.md}"

echo "Generating benchmark report from: $METRICS_DIR"

# Header
cat > "$OUTPUT_FILE" <<'HEADER'
# Benchmark Report

> Auto-generated by `generate-report.sh`

## Environment
HEADER

echo "- Date: $(date +%Y-%m-%d)" >> "$OUTPUT_FILE"
echo "- Host: $(uname -s) $(uname -m)" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Collect results from each project
echo "## Results" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
echo "| Project | Test Files | Compile | Tests Pass | Coverage (line) | Mutation Kill |" >> "$OUTPUT_FILE"
echo "|---------|-----------|---------|------------|-----------------|---------------|" >> "$OUTPUT_FILE"

for metrics_file in "$METRICS_DIR"/*-metrics.json; do
    [ -f "$metrics_file" ] || continue
    PROJECT=$(basename "$metrics_file" -metrics.json)

    FILES=$(python3 -c "import json; d=json.load(open('$metrics_file')); print(d['generation']['test_files_generated'])" 2>/dev/null || echo "?")
    COMPILE=$(python3 -c "import json; d=json.load(open('$metrics_file')); print('PASS' if d['compilation']['success'] else 'FAIL')" 2>/dev/null || echo "?")
    PASS_RATE=$(python3 -c "import json; d=json.load(open('$metrics_file')); print(d['execution']['pass_rate'])" 2>/dev/null || echo "?")
    COV=$(python3 -c "import json; d=json.load(open('$metrics_file')); print(d['coverage']['line'])" 2>/dev/null || echo "?")
    MUT=$(python3 -c "import json; d=json.load(open('$metrics_file')); print(d['mutation']['kill_rate'])" 2>/dev/null || echo "?")

    echo "| $PROJECT | $FILES | $COMPILE | $PASS_RATE | $COV | $MUT |" >> "$OUTPUT_FILE"
done

echo "" >> "$OUTPUT_FILE"

# Per-project details
for metrics_file in "$METRICS_DIR"/*-metrics.json; do
    [ -f "$metrics_file" ] || continue
    PROJECT=$(basename "$metrics_file" -metrics.json)

    echo "### $PROJECT" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo '```json' >> "$OUTPUT_FILE"
    cat "$metrics_file" >> "$OUTPUT_FILE"
    echo '```' >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
done

echo "[Report] Generated: $OUTPUT_FILE"
